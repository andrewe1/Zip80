<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Expense Tracker</title>
    <style>
        /* --- 1. GLOBAL STYLES --- */
        :root { 
            --primary: #2563eb; 
            --success: #16a34a; 
            --danger: #dc2626; 
            --bg: #f8fafc; 
            --text: #1e293b;
        }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px;
            height: 100vh; box-sizing: border-box;
        }

        /* --- 2. STARTUP OVERLAY --- */
        #startup-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
            border: 5px dashed transparent;
            transition: all 0.2s;
        }
        #startup-screen.drag-over {
            background: #eff6ff;
            border-color: var(--primary);
        }

        .big-btn {
            font-size: 1.2rem; padding: 18px 30px; margin: 10px;
            background: var(--primary); color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s; text-decoration: none;
            display: flex; align-items: center; gap: 10px;
        }
        .big-btn:hover { transform: scale(1.05); }
        .big-btn.secondary { background: white; color: #555; border: 2px solid #eee; box-shadow: none; }
        
        /* New: Recent File Button */
        .recent-file-btn {
            margin-top: 20px; color: var(--primary); background: none; border: none; 
            text-decoration: underline; cursor: pointer; font-size: 1rem;
            display: none; /* Hidden by default until we find a recent file */
        }

        /* --- 3. MAIN APP INTERFACE --- */
        #app-workspace { display: none; max-width: 600px; margin: 0 auto; }
        
        .card { 
            background: white; padding: 1.5rem; border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1.5rem; 
        }

        .balance-box { text-align: center; margin-bottom: 20px; }
        .balance-label { font-size: 0.9rem; text-transform: uppercase; color: #64748b; letter-spacing: 1px; }
        .balance-val { font-size: 3rem; font-weight: 800; color: var(--text); }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { 
            flex: 1; padding: 12px; border: 2px solid #e2e8f0; 
            border-radius: 8px; font-size: 1rem; outline: none;
        }
        input:focus { border-color: var(--primary); }
        
        .action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; color: white; font-size: 1rem;
        }
        .btn-green { background-color: var(--success); }
        .btn-red { background-color: var(--danger); }

        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .file-badge { background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 6px; font-size: 0.85rem;}
        .save-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 0; border-bottom: 1px solid #f1f5f9; 
        }
        .item-details { flex-grow: 1; }
        .item-desc { font-weight: 600; font-size: 1.1rem; display: block; }
        .item-date { font-size: 0.85rem; color: #94a3b8; }
        
        .item-actions { display: flex; align-items: center; gap: 10px; }
        .amount { font-weight: bold; font-size: 1.1rem; }
        .inc { color: var(--success); }
        .exp { color: var(--danger); }

        .icon-btn { 
            background: #f1f5f9; border: none; width: 36px; height: 36px; 
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: background 0.2s;
        }
        .icon-btn:hover { background: #e2e8f0; }
        .google-btn { color: #f59e0b; }
        .del-btn { color: #ef4444; }
    </style>
</head>
<body>

    <div id="startup-screen">
        <h1 style="margin-bottom: 5px;">Expense Tracker</h1>
        <p style="color: #666; margin-bottom: 40px; text-align: center; line-height: 1.5;">
            Click Open, or drag your data file here.
        </p>
        
        <button class="big-btn" onclick="openExistingFile()">
            <span>ðŸ“‚</span> Open File
        </button>
        <button class="big-btn secondary" onclick="createNewFile()">
            <span>âœ¨</span> New Data File
        </button>

        <button id="resume-btn" class="recent-file-btn" onclick="openRecent()">
            â†» Re-open last file
        </button>
    </div>

    <div id="app-workspace">
        <div class="header-bar">
            <span id="file-name-display" class="file-badge">Loading...</span>
            <button class="save-btn" id="save-btn" onclick="saveToDisk()">ðŸ’¾ Save Changes</button>
        </div>

        <div class="card">
            <div class="balance-box">
                <div class="balance-label">Current Balance</div>
                <div class="balance-val" id="balance-display">$0.00</div>
            </div>

            <div class="input-group">
                <input type="text" id="desc-input" placeholder="Description (e.g. Rent, Groceries)">
                <input type="number" id="amt-input" placeholder="Amount (0.00)">
            </div>
            
            <div class="input-group">
                <button class="action-btn btn-green" onclick="addTransaction('income')">âž• Add Income</button>
                <button class="action-btn btn-red" onclick="addTransaction('expense')">âž– Add Expense</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top: 0; color: #334155;">History</h3>
            <ul id="history-list" class="history-list"></ul>
        </div>
    </div>

    <script>
        let fileHandle = null;
        let transactions = [];

        // --- 0. BROWSER MEMORY (IndexedDB) ---
        // This is the magic that remembers the file location
        const dbName = 'ExpenseTrackerDB';
        const storeName = 'fileHandles';

        function getDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (e) => {
                    e.target.result.createObjectStore(storeName);
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveHandleToMemory(handle) {
            const db = await getDB();
            const tx = db.transaction(storeName, 'readwrite');
            tx.objectStore(storeName).put(handle, 'lastFile');
        }

        async function getHandleFromMemory() {
            const db = await getDB();
            return new Promise((resolve) => {
                const tx = db.transaction(storeName, 'readonly');
                const req = tx.objectStore(storeName).get('lastFile');
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        }

        // Check for recent file on startup
        window.addEventListener('DOMContentLoaded', async () => {
            const lastHandle = await getHandleFromMemory();
            if (lastHandle) {
                const btn = document.getElementById('resume-btn');
                btn.style.display = 'block';
                btn.innerText = `â†» Re-open '${lastHandle.name}'`;
            }
        });

        // --- 1. FILE OPERATIONS ---

        async function openExistingFile() {
            try {
                // Try to get last used location to start the picker there
                const lastHandle = await getHandleFromMemory();
                
                // Configure picker options
                const pickerOptions = {
                    types: [{ description: 'JSON File', accept: {'application/json': ['.json']} }],
                };

                // If we have a memory, tell browser to start there
                if (lastHandle) {
                    pickerOptions.startIn = lastHandle;
                }

                [fileHandle] = await window.showOpenFilePicker(pickerOptions);
                
                // Save this new handle to memory for next time
                await saveHandleToMemory(fileHandle);
                await loadFileContent();
            } catch (err) {
                // User cancelled
                console.log(err);
            }
        }

        async function openRecent() {
            // Specific flow for the "Re-open" text link
            try {
                const lastHandle = await getHandleFromMemory();
                if (!lastHandle) return alert("No recent file found.");
                
                // We verify permission. Browser will ask "Allow?" or just open it.
                if ((await lastHandle.queryPermission({ mode: 'read' })) !== 'granted') {
                    if ((await lastHandle.requestPermission({ mode: 'read' })) !== 'granted') {
                        return;
                    }
                }

                fileHandle = lastHandle;
                await loadFileContent();
            } catch (err) {
                alert("Could not open recent file. It might have moved.");
            }
        }

        async function createNewFile() {
            try {
                fileHandle = await window.showSaveFilePicker({
                    suggestedName: 'my_expenses.json',
                    types: [{ description: 'JSON File', accept: {'application/json': ['.json']} }],
                });
                transactions = [];
                await saveHandleToMemory(fileHandle);
                await saveToDisk(); 
                await loadFileContent();
            } catch (err) {
                // Cancelled
            }
        }

        async function loadFileContent() {
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                transactions = text ? JSON.parse(text) : [];
                
                document.getElementById('startup-screen').style.display = 'none';
                document.getElementById('app-workspace').style.display = 'block';
                document.getElementById('file-name-display').innerText = `Linked: ${file.name}`;
                render();
            } catch (error) {
                alert("Error reading file.");
            }
        }

        async function saveToDisk() {
            if (!fileHandle) return;
            try {
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(transactions, null, 2));
                await writable.close();
                
                const btn = document.getElementById('save-btn');
                const originalText = btn.innerText;
                btn.innerText = "âœ… Saved!";
                setTimeout(() => btn.innerText = originalText, 1500);
            } catch (e) {
                alert("Could not save. If using Drag-and-Drop, try using 'Open File' button instead.");
            }
        }

        // --- 2. DRAG AND DROP ---
        const dropZone = document.getElementById('startup-screen');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragover', () => dropZone.classList.add('drag-over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        
        dropZone.addEventListener('drop', async (e) => {
            dropZone.classList.remove('drag-over');
            const items = [...e.dataTransfer.items];
            if (items && items[0].kind === 'file') {
                const handle = await items[0].getAsFileSystemHandle();
                if(handle.kind === 'file') {
                    fileHandle = handle;
                    await saveHandleToMemory(fileHandle); // Save handle on drop too!
                    await loadFileContent();
                }
            }
        });

        // --- 3. APP LOGIC ---

        function addTransaction(type) {
            const descInput = document.getElementById('desc-input');
            const amtInput = document.getElementById('amt-input');
            const desc = descInput.value;
            const amt = parseFloat(amtInput.value);

            if (!desc || isNaN(amt)) return alert("Please enter details.");

            transactions.push({
                id: Date.now(),
                desc: desc,
                amt: type === 'income' ? amt : -amt,
                date: new Date().toISOString()
            });

            descInput.value = '';
            amtInput.value = '';
            render();
            saveToDisk(); 
        }

        function deleteTransaction(id) {
            if (confirm("Delete this entry?")) {
                transactions = transactions.filter(t => t.id !== id);
                render();
                saveToDisk();
            }
        }

        function addToGoogleCalendar(desc, dateStr, amount) {
            const cleanDate = dateStr.split('T')[0].replace(/-/g, '');
            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`Pay ${desc}: $${Math.abs(amount)}`)}&dates=${cleanDate}T100000/${cleanDate}T103000&details=${encodeURIComponent(`Reminder for ${desc}`)}`;
            window.open(url, '_blank');
        }

        function render() {
            const list = document.getElementById('history-list');
            const balanceEl = document.getElementById('balance-display');
            list.innerHTML = '';

            const total = transactions.reduce((acc, t) => acc + t.amt, 0);
            balanceEl.innerText = `$${total.toFixed(2)}`;
            balanceEl.style.color = total >= 0 ? '#1e293b' : '#dc2626';

            transactions.slice().sort((a,b) => b.id - a.id).forEach(t => {
                const isInc = t.amt >= 0;
                list.innerHTML += `
                <li class="history-item">
                    <div class="item-details">
                        <span class="item-desc">${t.desc}</span>
                        <span class="item-date">${new Date(t.date).toLocaleDateString()}</span>
                    </div>
                    <div class="item-actions">
                        <span class="amount ${isInc ? 'inc' : 'exp'}">${isInc ? '+' : ''}${t.amt.toFixed(2)}</span>
                        <button class="icon-btn google-btn" onclick="addToGoogleCalendar('${t.desc}', '${t.date}', ${t.amt})">ðŸ“…</button>
                        <button class="icon-btn del-btn" onclick="deleteTransaction(${t.id})">âœ•</button>
                    </div>
                </li>`;
            });
        }
    </script>
</body>
</html>